--DECLARE @AUTH_OPERADOR_ID INT = :AUTH_OPERADOR_ID;
--DECLARE @AUTH_REPRESENTANTE_ID INT = :AUTH_REPRESENTANTE_ID;

SELECT 

CASE WHEN ROW_NUMBER() OVER(ORDER BY ROUND(SANKHYA.SNK_DIVIDIR(SUM(M1.TOTAL),SUM(M1.OBJETIVO)) * 100,4) DESC) BETWEEN 1 AND 3 THEN
CASE WHEN ROUND(SANKHYA.SNK_DIVIDIR(SUM(M1.TOTAL),SUM(M1.OBJETIVO)) * 100,4) >= 100 THEN 
CONCAT(ROW_NUMBER() OVER(ORDER BY ROUND(SANKHYA.SNK_DIVIDIR(SUM(M1.TOTAL),SUM(M1.OBJETIVO)) * 100,4) DESC),'º Lugar',NULL) ELSE NULL END ELSE NULL END RANKING,

/*ROUND(SANKHYA.SNK_DIVIDIR(SUM(M1.TOTAL),SUM(M1.OBJETIVO)) * 100,2),*/

M1.APELIDO 'VENDEDOR (A)',
/*CASE WHEN @AUTH_REPRESENTANTE_ID= M1.CODVEND THEN SUM(M1.OBJETIVO)
     WHEN @AUTH_OPERADOR_ID = M1.CODVEND THEN SUM(M1.OBJETIVO) ELSE 0 END OBJETIVO,
	 
CASE WHEN @AUTH_REPRESENTANTE_ID = M1.CODVEND THEN SUM(M1.TOTAL)
     WHEN @AUTH_OPERADOR_ID = M1.CODVEND THEN SUM(M1.TOTAL)ELSE 0 END VENDIDO,*/

/* PREMIAÇÃO */

CASE WHEN ROUND(SANKHYA.SNK_DIVIDIR(SUM(M1.TOTAL),SUM(M1.OBJETIVO)) * 100,4) >= 100 THEN
CASE WHEN 
ROW_NUMBER() OVER(ORDER BY ROUND(SANKHYA.SNK_DIVIDIR(SUM(M1.TOTAL),SUM(M1.OBJETIVO)) * 100,4) DESC) = 1 THEN 'AR CONDICIONADO'
    WHEN ROW_NUMBER() OVER(ORDER BY ROUND(SANKHYA.SNK_DIVIDIR(SUM(M1.TOTAL),SUM(M1.OBJETIVO)) * 100,4) DESC) = 2 THEN 'RELÓGIO XIOMI'
	WHEN ROW_NUMBER() OVER(ORDER BY ROUND(SANKHYA.SNK_DIVIDIR(SUM(M1.TOTAL),SUM(M1.OBJETIVO)) * 100,4) DESC) = 3 THEN 'FORNO E FRYER' ELSE NULL END ELSE NULL END PRÊMIOS

FROM(
  
SELECT 

VEN.CODVEND,
VEN.APELIDO,
MT.VLRTOT OBJETIVO,
ROUND(SUM(((ITE.VLRTOT - ITE.VLRDESC - ITE.VLRREPRED + ITE.VLRSUBST + ITE.VLRIPI) * VCA.INDITENS ) * TPO.GOLDEV),2) TOTAL,
COUNT(DISTINCT(CAB.CODPARC)) CLIENTE

FROM SANKHYA.TGFCAB CAB

INNER JOIN SANKHYA.TGFITE ITE ON (ITE.NUNOTA=CAB.NUNOTA)
RIGHT JOIN SANKHYA.VGFCAB VCA ON (VCA.NUNOTA=CAB.NUNOTA)
INNER JOIN SANKHYA.TGFPRO PRO ON (PRO.CODPROD=ITE.CODPROD)
INNER JOIN SANKHYA.TGFTOP TPO ON (TPO.CODTIPOPER=CAB.CODTIPOPER AND TPO.DHALTER=CAB.DHTIPOPER)
INNER JOIN SANKHYA.TGFVEN VEN ON (VEN.CODVEND=CAB.CODVEND)
INNER JOIN SANKHYA.AD_METAVENDEDOR MT ON (MT.CODVEND = VEN.CODVEND AND MT.DTREF >= CONVERT(DATE,'13/11/2023',103) AND MT.DTREFIN <= CONVERT(DATE,'18/11/2023',103) AND MT.IDMETA = 26)

WHERE CAB.DTNEG BETWEEN CONVERT(DATE,'13/11/2023',103) AND CONVERT(DATE,'18/11/2023',103)
AND CAB.STATUSNOTA= 'L' AND CAB.TIPMOV IN ('V','D') AND TPO.GOLSINAL = -1

GROUP BY VEN.CODVEND,VEN.APELIDO,MT.VLRTOT ) M1

GROUP BY M1.APELIDO,M1.CODVEND